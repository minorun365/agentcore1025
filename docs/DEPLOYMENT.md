# AgentCore Runtime è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ãŸã¨ãã«ã€è‡ªå‹•çš„ã«ECRã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦AgentCore Runtimeã‚’æ›´æ–°ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ¯ ä»•çµ„ã¿ã®æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. backend/** ã‚’å¤‰æ›´ã—ã¦ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GitHub Actions ãŒè‡ªå‹•å®Ÿè¡Œ                                   â”‚
â”‚    - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰(ARM64)                              â”‚
â”‚    - ECRã«ãƒ—ãƒƒã‚·ãƒ¥                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. AgentCore Runtime ã‚’æ›´æ–°                                     â”‚
â”‚    - UpdateAgentRuntime API å®Ÿè¡Œ                                â”‚
â”‚    - è‡ªå‹•çš„ã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DEFAULTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè‡ªå‹•æ›´æ–°                              â”‚
â”‚    - æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å³åº§ã«å‚ç…§                                 â”‚
â”‚    - CDKã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦!                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: GitHub Actionsç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

ã¾ãšã€GitHub ActionsãŒAWSãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cd infrastructure

# GitHub OIDCèªè¨¼ç”¨ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
cdk deploy GitHubActionsRoleStack
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®å‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
Outputs:
GitHubActionsRoleStack.GitHubActionsRoleArn = arn:aws:iam::123456789012:role/GitHubActionsDeployRole
```

**ã“ã®ARNã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„** - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã„ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—2: GitHub Secretsã‚’è¨­å®š

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•
2. **Settings** > **Secrets and variables** > **Actions** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **New repository secret** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›:
   - Name: `AWS_ROLE_ARN`
   - Value: (ã‚¹ãƒ†ãƒƒãƒ—1ã§ã‚³ãƒ”ãƒ¼ã—ãŸARN)
5. **Add secret** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

[.github/workflows/deploy-agentcore.yml](../.github/workflows/deploy-agentcore.yml) ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’å®Ÿéš›ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„:

```yaml
env:
  AWS_REGION: us-west-2  # ã‚ãªãŸã®AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  ECR_REPOSITORY: agentcore-strands-agent  # ECRãƒªãƒã‚¸ãƒˆãƒªåã«å¤‰æ›´
  AGENT_RUNTIME_ID: your-agent-runtime-id  # AgentCore Runtime IDã«å¤‰æ›´
```

#### ğŸ“ å¿…è¦ãªæƒ…å ±ã®å–å¾—æ–¹æ³•

**ECRãƒªãƒã‚¸ãƒˆãƒªåã‚’ç¢ºèª:**
```bash
aws ecr describe-repositories --region us-west-2 --query 'repositories[].repositoryName'
```

**AgentCore Runtime IDã‚’ç¢ºèª:**
```bash
aws bedrock-agentcore list-agent-runtimes --region us-west-2
```

### ã‚¹ãƒ†ãƒƒãƒ—4: å‹•ä½œç¢ºèª

1. backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´
2. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ&ãƒ—ãƒƒã‚·ãƒ¥:
   ```bash
   git add backend/
   git commit -m "Update Strands agent code"
   git push origin main
   ```
3. GitHubã® **Actions** ã‚¿ãƒ–ã§å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª
4. ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰ã€AgentCore RuntimeãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™!

## ğŸš€ ä½¿ã„æ–¹

### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤(æ¨å¥¨)

backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã ã‘ã§ã€è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™:

```bash
# agent.pyã‚’ç·¨é›†
vi backend/agent.py

# ã‚³ãƒŸãƒƒãƒˆ&ãƒ—ãƒƒã‚·ãƒ¥
git add backend/agent.py
git commit -m "feat: Add new tool for agent"
git push origin main
```

GitHub ActionsãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã€ç´„5-10åˆ†ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã™ã€‚

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

ç·Šæ€¥æ™‚ã¯ã€GitHub Actionsã®UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã§ã™:

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã® **Actions** ã‚¿ãƒ–ã‚’é–‹ã
2. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **Deploy Agentcore Runtime** ã‚’é¸æŠ
3. **Run workflow** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠã—ã¦ **Run workflow** ã‚’å®Ÿè¡Œ

## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ã®ç¢ºèª

### GitHub Actionsã®ãƒ­ã‚°ã§ç¢ºèª

GitHub Actionsã®å®Ÿè¡Œãƒ­ã‚°ã§ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã™:

- Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰çŠ¶æ³
- ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥çµæœ
- AgentCore Runtimeã®æ›´æ–°çŠ¶æ³
- æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·

### AWS CLIã§ç¢ºèª

```bash
# ç¾åœ¨ã®AgentCore Runtimeã®çŠ¶æ…‹ã‚’ç¢ºèª
aws bedrock-agentcore describe-agent-runtime \
  --agent-runtime-id <your-agent-runtime-id> \
  --region us-west-2

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã‚’ç¢ºèª
aws bedrock-agentcore list-agent-runtime-versions \
  --agent-runtime-id <your-agent-runtime-id> \
  --region us-west-2

# ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ã‚’ç¢ºèª
aws bedrock-agentcore list-agent-runtime-endpoints \
  --agent-runtime-id <your-agent-runtime-id> \
  --region us-west-2
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒå¤±æ•—ã™ã‚‹

**åŸå› **: IAMãƒ­ãƒ¼ãƒ«ã«ECRã®æ¨©é™ãŒãªã„

**è§£æ±ºç­–**:
```bash
# GitHubActionsRoleStackã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
cd infrastructure
cdk deploy GitHubActionsRoleStack
```

### UpdateAgentRuntime APIãŒå¤±æ•—ã™ã‚‹

**åŸå› **: IAMãƒ­ãƒ¼ãƒ«ã«AgentCore Runtimeã®æ¨©é™ãŒãªã„ã€ã¾ãŸã¯è¨­å®šãŒä¸æ­£

**è§£æ±ºç­–**:
1. IAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’ç¢ºèª
2. AgentCore Runtime IDãŒæ­£ã—ã„ã‹ç¢ºèª
3. ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã—ã¦ã€å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèª:
   ```bash
   aws bedrock-agentcore describe-agent-runtime \
     --agent-runtime-id <your-agent-runtime-id> \
     --region us-west-2
   ```

### Runtime ãŒ READY ã«ãªã‚‰ãªã„

**åŸå› **: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å•é¡ŒãŒã‚ã‚‹ã€ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã®å•é¡Œ

**è§£æ±ºç­–**:
1. ãƒ­ãƒ¼ã‚«ãƒ«ã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆ:
   ```bash
   cd backend
   docker build --platform linux/arm64 -t test-agent .
   docker run -p 8080:8080 test-agent
   ```
2. CloudWatch Logsã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
3. AgentCore Runtimeã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°ã‚’ç¢ºèª

## ğŸ“ çŸ¥ã£ã¦ãŠãã¹ãã“ã¨

### ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã®ä»•çµ„ã¿

- **è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹ã¨ã€AgentCore Runtimeã¯è‡ªå‹•çš„ã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™
- **DEFAULTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: å¸¸ã«æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¾ã™(è‡ªå‹•æ›´æ–°)
- **ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: æ‰‹å‹•ã§æ›´æ–°ãŒå¿…è¦ã§ã™

### æœ¬ç•ªç’°å¢ƒç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç®¡ç†

æœ¬ç•ªç’°å¢ƒç”¨ã«åˆ¥ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(ä¾‹: `production`)ã‚’ä½œæˆã—ã¦ã„ã‚‹å ´åˆã¯ã€æ‰‹å‹•ã§æ›´æ–°ãŒå¿…è¦ã§ã™:

```bash
# æœ¬ç•ªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
aws bedrock-agentcore update-agent-runtime-endpoint \
  --agent-runtime-id <your-agent-runtime-id> \
  --endpoint-name production \
  --agent-runtime-version <new-version> \
  --region us-west-2
```

### CDKå†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹

ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†å ´åˆã¯ã€GitHub Actionsã§ã¯ãªãã€CDKã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™:

- IAMãƒ­ãƒ¼ãƒ«ã®å¤‰æ›´
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã®å¤‰æ›´(VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—)
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«è¨­å®šã®å¤‰æ›´
- ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ ãƒ»å‰Šé™¤(æ—¢å­˜ã®ç’°å¢ƒå¤‰æ•°ã®å€¤ã®å¤‰æ›´ã®ã¿ãªã‚‰ã€GitHub Actionsã§å¯èƒ½)

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [AgentCore Runtime ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agent-runtime-versioning.html)
- [UpdateAgentRuntime API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.aws.amazon.com/bedrock-agentcore-control/latest/APIReference/API_UpdateAgentRuntime.html)
- [GitHub Actions OIDCèªè¨¼](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
