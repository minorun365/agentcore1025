name: Deploy Agentcore Runtime

# backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦è‡ªå‹•å®Ÿè¡Œ
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-agentcore.yml'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: strands-agent  # ECRãƒªãƒã‚¸ãƒˆãƒªå
  AGENT_RUNTIME_ID: strandsAgent-oo5xY1C4tn  # AgentCore Runtime ID

permissions:
  id-token: write  # OIDCèªè¨¼ç”¨
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AWSèªè¨¼(OIDCæ¨å¥¨)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. ECRã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥
      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend

          # ARM64å‘ã‘ã«ãƒ“ãƒ«ãƒ‰(AgentCore Runtimeã®è¦ä»¶)
          docker buildx create --use --name arm-builder || true
          docker buildx build \
            --platform linux/arm64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --push \
            .

          echo "æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ:"
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 5. AgentCore Runtimeã‚’æ›´æ–°(è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°)
      - name: Update AgentCore Runtime
        id: update-runtime
        env:
          IMAGE_URI: ${{ steps.build-image.outputs.image_uri }}
        run: |
          echo "AgentCore Runtimeã‚’æ›´æ–°ä¸­..."

          # UpdateAgentRuntime APIã‚’å®Ÿè¡Œ
          # æ³¨æ„: å®Ÿéš›ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚„IAMãƒ­ãƒ¼ãƒ«ARNã¯æ—¢å­˜ã®å€¤ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
          # ã¾ãšç¾åœ¨ã®è¨­å®šã‚’å–å¾—
          CURRENT_CONFIG=$(aws bedrock-agentcore describe-agent-runtime \
            --agent-runtime-id $AGENT_RUNTIME_ID \
            --region $AWS_REGION)

          ROLE_ARN=$(echo $CURRENT_CONFIG | jq -r '.roleArn')
          NETWORK_MODE=$(echo $CURRENT_CONFIG | jq -r '.networkConfiguration.networkMode')

          # AgentCore Runtimeã‚’æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã§æ›´æ–°
          UPDATE_RESPONSE=$(aws bedrock-agentcore update-agent-runtime \
            --agent-runtime-id $AGENT_RUNTIME_ID \
            --region $AWS_REGION \
            --agent-runtime-artifact "{
              \"containerImage\": {
                \"imageUri\": \"$IMAGE_URI\"
              }
            }" \
            --role-arn "$ROLE_ARN" \
            --network-configuration "{
              \"networkMode\": \"$NETWORK_MODE\"
            }")

          # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
          NEW_VERSION=$(echo $UPDATE_RESPONSE | jq -r '.agentRuntimeVersion')
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 6. DEFAULTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ã®ã‚’å¾…æ©Ÿ
      - name: Wait for Runtime to be ready
        run: |
          echo "AgentCore RuntimeãŒæº–å‚™å®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿä¸­..."

          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws bedrock-agentcore describe-agent-runtime \
              --agent-runtime-id $AGENT_RUNTIME_ID \
              --region $AWS_REGION \
              --query 'status' \
              --output text)

            echo "ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"

            if [ "$STATUS" = "READY" ]; then
              echo "âœ… AgentCore RuntimeãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ!"
              exit 0
            elif [ "$STATUS" = "UPDATE_FAILED" ]; then
              echo "âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "å¾…æ©Ÿä¸­... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 30
          done

          echo "âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: AgentCore Runtimeã®æº–å‚™ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ"
          exit 1

      # 7. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: Deployment successful
        run: |
          echo "ğŸ‰ AgentCore RuntimeãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ!"
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.update-runtime.outputs.version }}"
          echo "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸: ${{ steps.build-image.outputs.image_uri }}"
          echo ""
          echo "DEFAULTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯è‡ªå‹•çš„ã«æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚"
          echo "æœ¬ç•ªç’°å¢ƒç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€æ‰‹å‹•ã§æ›´æ–°ã—ã¦ãã ã•ã„:"
          echo "aws bedrock-agentcore update-agent-runtime-endpoint \\"
          echo "  --agent-runtime-id $AGENT_RUNTIME_ID \\"
          echo "  --endpoint-name production-endpoint \\"
          echo "  --agent-runtime-version ${{ steps.update-runtime.outputs.version }}"
